jobs-queue
==========

Сервис для запуска фоновых задач. Позволяет регулировать количество одновременных воркеров
(**workers**), размер очереди задач (**queue_size**), и пропускать запуск одинаковых задач (в
зависимости от выбранного значения **cache_delete_mode**).

* Получает по unix socket (**socket**) задание в виде обычной строки (command line).
* Если такая задача уже была запущена ранее (**cache_expire** секунд назад), то пропускает её
  выполнение. Иначе - передаёт задачу воркерам через общую очередь.
* Воркер разбирает command line с помощью модуля google shlex и запускает через exec.Run. Если
  задание выводи что-нибудь в stdout/stderr, то всё это логируется.

Чтобы ограничить права воркеров, нужно запускать сервис jobs-queue от имени пользователя с
ограниченными правами и выставить соответсвующие права доступа на файл сокета.

**cache_delete_mode**:

* **expire** (по-умолчанию): задание попадает в кэш с установленным временем жизни **cache_expire**
  секунд. Задание удаляется из кэша по окончанию указанного времени.

* **complete**: задание попадает в кэш с бесконечным временем жизни. Задание удаляется из кэша по
  окончанию выполнения.

* **expire_complete**: задание попадает в кэш с установленным временем жизни **cache_expire**
  секунд. Задание удаляется из кэша либо по окочанию указанного времени, либо по окончанию
  выполнения.

* **cache_excludes**: информацию о запуске некоторых задач не нужно кэшировать (запускать их нужно
  всегда). Этот список из regexp-ов позволяет указать эти задачи.

Разработка
----------

Собрать релиз:

```bash
git clone ...
cd jobs-queue
make archive
# подготовленный архив появится в каталоге dist
```

Чтобы отправить задачу на выполнение, нужно передать command line через unix datagram socket,
например:

```bash
printf "sleep 30" | nc /tmp/jobs-queue.socket -Uu
```
